
@{
    ViewData["Title"] = Model.JFZT != 1 ? "自助缴费" : "缴费详情";
    Layout = "~/Views/Shared/_Layout.cshtml";
    var d = Model;
}

<header class="mui-bar mui-bar-nav">
    <a class="mui-action-back mui-icon mui-icon-left-nav mui-pull-left"></a>
    <h1 class="mui-title">自助缴费</h1>
</header>
<div class="mui-content">
    <div class="mui-card">
        <form class="mui-input-group">
            <div class="mui-input-row" style="padding-bottom:20px">
                <label>收款单位</label>
                <input type="text" value="@ViewBag.Payee" readonly>
            </div>
            <div class="mui-input-row" style="padding-bottom:20px">
                <label>房屋编号</label>
                <input type="text" value="@d.FWBH" readonly>
            </div>
            <div class="mui-input-row">
                <label>房屋名称</label>
                <input type="text" value="@d.FWMC" readonly>
            </div>
            <div class="mui-input-row">
                <label>缴费类型</label>
                <input type="text" value="@d.JFLXName" readonly>
            </div>
            @{
                if (d.JFLX == "0")
                {
                    <div class="mui-input-row">
                        <label>有效期起</label>
                        <input type="text" value="@d.YXQS" readonly>
                    </div>
                    <div class="mui-input-row">
                        <label>有效期止</label>
                        <input type="text" value="@d.YXQZ" readonly>
                    </div>
                }
                if (d.JFLX == "1")
                {
                    <div class="mui-input-row">
                        <label>水表编号</label>
                        <input type="text" value="@d.WATER_NUMBER" readonly>
                    </div>
                }
                else if (d.JFLX == "2")
                {
                    <div class="mui-input-row">
                        <label>电表编号</label>
                        <input type="text" value="@d.ELE_NUMBER" readonly>
                    </div>
                }
            }

            <div class="mui-input-row">
                <label>手机号码</label>
                <input type="text" value="@d.MOBILE_PHONE" readonly>
            </div>
        </form>
    </div>
    <div class="mui-card">
        <div class="mui-input-row" style="padding-bottom:20px;padding-top:10px">
            <label>缴费金额</label>
            <input type="text" value="￥@d.JFJE.ToString("0.00")" style="color:orange;font-size:25px" readonly>
        </div>
    </div>
    <p style="margin: 40px 10px;"></p>
    <div class="mui-col-sm-12 mui-col-xs-12" style="text-align:center;">
        @{
            if (d.JFZT != 1)
            {
                <button type="button" class="mui-btn mui-btn-primary pay" style="width:91%;" id="submit">立即支付</button>
            }
            else
            {
                <button type="button" class="mui-btn mui-btn-success detail" style="width:91%;" id="submit">查看收据</button>
            }
        }
    </div>
</div>
<style>
    /*隐藏google touch事件错误*/
    * {
        touch-action: none;
    }

    .mui-card input {
        text-align: right;
    }
</style>
<script type="text/javascript">
    jq = $;
    (function ($) {
        $.init({
            swipeBack: true //启用右滑关闭功能
        });
        var Sign = {};
        var payInit = function () {
            if (typeof WeixinJSBridge == "undefined") {
                if (document.addEventListener) {
                    document.addEventListener('WeixinJSBridgeReady', onBridgeReady, false);
                } else if (document.attachEvent) {
                    document.attachEvent('WeixinJSBridgeReady', onBridgeReady);
                    document.attachEvent('onWeixinJSBridgeReady', onBridgeReady);
                }
            } else {
                onBridgeReady();
            }
        }
        var payed = false;
        var onBridgeReady = function () {
            WeixinJSBridge.invoke(
                'getBrandWCPayRequest', Sign,
                function (res) {
                    if (res.err_msg == "get_brand_wcpay_request:ok") {
                        payed = true;
                        mui.hideLoading();
                        // 使用以上方式判断前端返回,微信团队郑重提示：
                        //res.err_msg将在用户支付成功后返回ok，但并不保证它绝对可靠。
                        var btnArray = ['否', '是'];
                        mui.confirm('是否已付款？', '提示', btnArray, function (e) {
                            if (e.index == 1) {
                                window.location.reload;
                            }
                        })
                        console.log(res);
                    }
                });
        }
        jq("button.pay").on("tap", function () {
            mui.showLoading();
            $.post("CreateOrder", { houseId: "@d.FWID", recordId: "@d.RECORD_ID", UId: "@d.CZ_SHID" }, function (res) {
                if (res == null || res.code != 1000) {
                    mui.hideLoading();
                   mui.alert("生成订单失败！","提示");
                   return;
               }
               var data = res.data || null;
                if (data != null) {
                    Sign = data.sign;
                    if (Sign == null) {
                        mui.hideLoading();
                        mui.alert("预支付失败！", "提示");
                    }
                    payInit();
                } else {
                    mui.hideLoading();
                   mui.alert("数据错误！", "提示");
                   return;
               }
            });
        })
        jq("button.detail").on("tap", function () {
            window.location.href = "OrderDetail/@d.ID";
        });
    })(mui)


</script>
